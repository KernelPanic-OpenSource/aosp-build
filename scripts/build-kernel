#!/bin/bash
# shellcheck disable=SC1090
[ -f /.dockerenv ] || { echo "please run in supplied container"; exit 1; }
set -e; eval "$(environment)"

device="${DEVICE?}"
config_name="${CONFIG_NAME?}"
external_dir="${EXTERNAL_DIR?}"
manifest_dir="${MANIFEST_DIR?}/${config_name}"
key_dir="${KEY_DIR:-${PWD}/keys/${device}}"
kernel_name="${KERNEL_NAME?}"
kernel_dir="${external_dir}/kernel/${kernel_name}"
cores=$(nproc)

mkdir -p "${kernel_dir}"
cd "${kernel_dir}"
cat /etc/gitconfig > "$HOME/.gitconfig"
repo init \
	--manifest-url "${manifest_dir}" \
	--manifest-name "kernel-${kernel_name}.xml"
repo sync -c --no-tags --no-clone-bundle --jobs "${cores}"
repo forall -c 'git reset --hard ; git clean -fdx'
ln -vs \
	"${key_dir}/kernel.pem" \
	"${kernel_dir}/private/msm-google/certs/signing_key.pem"

cat <<-EOF | bash
	export OUT_DIR="${kernel_dir}/out"
	export DIST_DIR="${kernel_dir}/dist"
	bash "${kernel_dir}/build/build.sh" -j$(cores)
EOF
