#!/bin/bash
set -e

device="${DEVICE?}"
base_dir="$PWD/base"
external_dir="${EXTERNAL_DIR:-$PWD/external}"
version=$(
	grep -Po \
		"export BUILD_ID=\\K.+" \
		"${base_dir}/build/core/build_id.mk" \
	| tr '[:upper:]' '[:lower:]' \
)
vendor_dist="${external_dir}/vendor/out/${device}/${version}/vendor"
vendor_dest="${base_dir}/vendor"
chromium_dist="${external_dir}/chromium/src/out/Default/apks"
chromium_dest="${base_dir}/external/chromium/prebuilt/arm64"
kernel_dist="${external_dir}/kernel/${device}/out/android-*/dist"
kernel_dest="${base_dir}/device/google/${device}-kernel"

rm -rf "$vendor_dest" "$chromium_dest" "$kernel_dest"

[ -d "${vendor_dist}" ] || build-vendor
cp -R "${vendor_dist}" "${vendor_dest}"

[ -d "${chromium_dist}" ] || build-chromium
cp -f "${chromium_dist}" "${chromium_dest}"

[ -d "$kernel_dist" ] || build-kernel
cp -R "${kernel_dist}" "${kernel_dest}"

build-platform
